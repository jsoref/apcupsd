10.4+ Universal Binary Builds from XCode 3.x

The information in this file is for those who wish to build an apcupsd binary 
package to run on machines other than the machine on which it was built. If you 
are building apcupsd for use on the same machine as the one you are building it 
on, you do not have to do any of this. In that case, just install dependent 
libs such as libgd and libusb binaries from Fink or MacPorts (or build from 
source) with no special treatment needed.

To build the most compatible apcupsd binary package possible, we must...

* Build universal binaries to support PPC and Intel platforms (so-called "fat"
  binaries)
* Build all dependent libraries static to ensure no extra dylibs are needed on
  the taget machine
* Target the MacOS 10.4 "Universal" SDK to ensure the binaries will run on all
  platforms >= 10.4

Instructions:

- Install XCode-3.x (tested on 3.1 with 10.5 and 3.2 with 10.6) 
  * Be sure to select the 10.4 SDK when installing
  * After installing, check if /Developer/SDKs/MacOSX10.4u.sdk/usr/local/lib
    is a symlink to /usr/local/lib. If so, remove it.
  * This procedure will NOT work on older versions of XCode

- Build dependent libs (libusb, libpng, libgd)

  libpng & libusb:

   CPPFLAGS="-isysroot /Developer/SDKs/MacOSX10.4u.sdk -mmacosx-version-min=10.4" \
     LDFLAGS="-isysroot /Developer/SDKs/MacOSX10.4u.sdk -mmacosx-version-min=10.4 -arch i386 -arch ppc" \
     CFLAGS="-arch i386 -arch ppc" CXXFLAGS="-arch i386 -arch ppc" \
     CC=gcc-4.0 CXX=g++-4.0 ./configure \
     --prefix=/Developer/SDKs/MacOSX10.4u.sdk/usr/local --disable-shared \
     --disable-dependency-tracking
  make
  sudo make install

  libgd (depends on libpng, so build/install that first):

   CPPFLAGS="-isysroot /Developer/SDKs/MacOSX10.4u.sdk -mmacosx-version-min=10.4" \
     LDFLAGS="-isysroot /Developer/SDKs/MacOSX10.4u.sdk -mmacosx-version-min=10.4 -arch i386 -arch ppc" \
     CFLAGS="-arch i386 -arch ppc" CXXFLAGS="-arch i386 -arch ppc" \
     PATH="/Developer/SDKs/MacOSX10.4u.sdk/usr/local/bin:$PATH" \
     CC=gcc-4.0 CXX=g++-4.0 ./configure \
     --prefix=/Developer/SDKs/MacOSX10.4u.sdk/usr/local --disable-shared \
     --disable-dependency-tracking --without-fontconfig --without-freetype \
     --without-x
  make
  sudo make install

- Build apcupsd

   CPPFLAGS="-isysroot /Developer/SDKs/MacOSX10.4u.sdk -mmacosx-version-min=10.4" \
     LDFLAGS="-isysroot /Developer/SDKs/MacOSX10.4u.sdk -mmacosx-version-min=10.4" \
     PATH="$PATH:/Developer/SDKs/MacOSX10.4u.sdk/usr/local/bin" \
     CC=gcc-4.0 CXX=g++-4.0 ./configure \
     --enable-usb --enable-cgi --enable-snmp
   make

- Build binary package

   cd platforms/darwin
   sudo make apcupsd.pkg

The resulting binary package is found in platforms/darwin/Apcupsd-<version>.dmg
